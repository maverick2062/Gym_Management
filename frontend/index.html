<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple CSS to show/hide the modal */
        .modal { display: none; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="auth-view" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <h2 id="auth-title" class="text-2xl font-bold text-center text-gray-900">Sign in to your account</h2>
            <p id="auth-subtitle" class="text-sm text-center">
                Or <a href="#" id="toggle-auth-mode" class="font-medium text-indigo-600 hover:text-indigo-500">create a new account</a>
            </p>
            
            <form id="auth-form" class="space-y-6">
                <div id="name-field" class="hidden">
                    <label for="name" class="text-sm font-medium text-gray-700">Full Name</label>
                    <input id="name" name="name" type="text" class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="email" class="text-sm font-medium text-gray-700">Email</label>
                    <input id="email" name="email" type="email" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="you@example.com">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-700">Password</label>
                    <input id="password" name="password" type="password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="••••••••">
                </div>
                <div>
                    <button type="submit" id="auth-button" class="w-full px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Sign in
                    </button>
                </div>
            </form>
            <p id="auth-error" class="text-sm text-center text-red-600"></p>
        </div>
    </div>

    <div id="dashboard-view" class="hidden">
        <nav class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <span class="text-xl font-bold">GymMonk Dashboard</span>
                    </div>
                    <div class="flex items-center">
                        <span id="user-info" class="mr-4 text-sm text-gray-600"></span>
                        <button id="logout-button" class="px-3 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Logout</button>
                    </div>
                </div>
            </div>
        </nav>
        <main class="py-10">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Member Management</h2>
                        <button id="add-member-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">Add Member</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Plan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Join Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="member-list" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8 mb-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Active Members</p>
                            <p id="stats-active-members" class="text-3xl font-bold text-green-500">0</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Members</p>
                            <p id="stats-total-members" class="text-3xl font-bold">0</p>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Monthly Plan</p>
                            <p id="stats-plan-monthly" class="text-3xl font-bold">0</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Quarterly Plan</p>
                            <p id="stats-plan-quarterly" class="text-3xl font-bold">0</p>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Yearly Plan</p>
                            <p id="stats-plan-yearly" class="text-3xl font-bold">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="member-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <h3 id="modal-title" class="text-lg font-medium leading-6 text-gray-900 mb-4">Add New Member</h3>
            <form id="member-form">
                <div class="space-y-4">
                    <div>
                        <label for="member-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="member-name" required class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="member-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="member-email" required class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="member-plan" class="block text-sm font-medium text-gray-700">Membership Plan</label>
                        <select id="member-plan" required class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md">
                            <option>Monthly</option>
                            <option>Quarterly</option>
                            <option>Yearly</option>
                        </select>
                    </div>
                </div>
                <div class="items-center px-4 py-3 mt-5 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 sm:ml-3 sm:w-auto sm:text-sm">
                        Save Member
                    </button>
                    <button type="button" id="cancel-modal-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // DOM Elements
        const authView = document.getElementById('auth-view');
        const dashboardView = document.getElementById('dashboard-view');
        const authForm = document.getElementById('auth-form');
        const authError = document.getElementById('auth-error');
        const authTitle = document.getElementById('auth-title');
        const authSubtitle = document.getElementById('auth-subtitle');
        const authButton = document.getElementById('auth-button');
        const nameField = document.getElementById('name-field');
        const toggleAuthModeLink = document.getElementById('toggle-auth-mode');
        const userInfo = document.getElementById('user-info');
        const memberList = document.getElementById('member-list');
        const logoutButton = document.getElementById('logout-button');
        const addMemberBtn = document.getElementById('add-member-btn');
        const memberModal = document.getElementById('member-modal');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const memberForm = document.getElementById('member-form');
        
        let isLoginMode = true;
        let currentUserRole = null;

        // --- Helper function to get the token ---
        function getToken() {
            return localStorage.getItem('jwt_token');
        }

        // --- Helper function to parse JWT ---
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        // --- API Functions ---
        async function loginUser(email, password) {
            const response = await fetch('http://127.0.0.1:5000/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await response.json();
            if (!response.ok) { throw new Error(data.error || 'Login failed.'); }

             // ** NEW: Save the token on successful login **
            localStorage.setItem('jwt_token', data.token);
            const payload = parseJwt(data.token);
            currentUserRole = payload.role; // <-- ADD THIS LINE

            return data;
        }

        async function registerUser(name, email, password) {
            const response = await fetch('http://127.0.0.1:5000/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email, password })
            });
            const data = await response.json();
            if (!response.ok) { throw new Error(data.error || 'Registration failed.'); }
            alert('Registration successful! Please log in.');
            toggleMode(true);
        }

        async function fetchMembers() {
            try {
                const response = await fetch('http://127.0.0.1:5000/api/members/', {// Added trailing slash for consistency
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                if (!response.ok) { throw new Error('Could not fetch members.'); }
                const members = await response.json();
                renderMembers(members);
            } catch (error) {
                console.error('Fetch Members Error:', error);
                memberList.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">${error.message}</td></tr>`;
            }
        }

        async function addMember(memberData) {
            try {
                // ** NEW: Add Authorization header with the token **
                const response = await fetch('http://127.0.0.1:5000/api/members/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify(memberData),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to add member.');
                }
                fetchMembers(); // Re-fetch the list to show the new member
                memberModal.classList.remove('active'); // Hide the modal
            } catch (error) {
                console.error('Add Member Error:', error);
                alert(error.message);
            }
        }
        async function updateMember(memberId, memberData) {
            try {
                // ** NEW: Add Authorization header with the token **
                const response = await fetch(`http://127.0.0.1:5000/api/members/update/${memberId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify(memberData),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update member.');
                }
                fetchMembers(); // Refresh the list
                memberModal.classList.remove('active'); // Close modal on success
            } catch (error) {
                console.error('Update Member Error:', error);
                alert(error.message);
            }
        }

        async function deleteMember(memberId) {
            if (!confirm('Are you sure you want to delete this member?')) {
                return;
            }
            try {
                // ** NEW: Add Authorization header with the token **
                const response = await fetch(`http://127.0.0.1:5000/api/members/delete/${memberId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to delete member.');
                }
                fetchMembers(); // Refresh the list to show the member has been removed
            } catch (error) {
                console.error('Delete Member Error:', error);
                alert(error.message);
            }
        }

        async function fetchDashboardStats() {
            try {
                const response = await fetch('http://127.0.0.1:5000/api/members/stats',{
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });
                if (!response.ok) { throw new Error('Could not fetch stats.'); }
                const stats = await response.json();
                renderDashboardStats(stats);
            } catch (error) {
                console.error('Fetch Stats Error:', error);
            }
        }

        // --- UI Functions ---
        function renderMembers(members) {
            if (!members || members.length === 0) {
                // Note: Colspan is 5 to account for the Actions column
                memberList.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No members found.</td></tr>`;
                return;
            }
            let html = '';
            members.forEach(member => {
                const joinDate = new Date(member.join_date).toLocaleDateString('en-GB');
                
                // THE SECURITY CHECK: Conditionally add action buttons only for admins
                let actionButtons = '';
                if (currentUserRole === 'admin') {
                    actionButtons = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick='openEditModal(${JSON.stringify(member)})' class="text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                            <button onclick='deleteMember(${member.member_id})' class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    `;
                } else {
                    actionButtons = `<td class="px-6 py-4"></td>`; // Render an empty cell for non-admins
                }

                html += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${member.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${member.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${member.membership_plan}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${joinDate}</td>
                        ${actionButtons} 
                    </tr>
                `;
            });
            memberList.innerHTML = html;
        }

        function openEditModal(member) {
            // Set a data attribute on the form to store the member's ID
            memberForm.dataset.editingId = member.member_id;
            
            // Pre-fill the form fields
            document.getElementById('modal-title').textContent = 'Edit Member';
            document.getElementById('member-name').value = member.name;
            document.getElementById('member-email').value = member.email;
            document.getElementById('member-plan').value = member.membership_plan;
            
            // Show the modal
            memberModal.classList.add('active');
        }
        
        function showDashboard(userData) {
            authView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            userInfo.textContent = `Welcome, ${userData.user.name}!`;
            fetchMembers();
            fetchDashboardStats();
        }

        function showLoginView() {
            // Clear the token from storage
            localStorage.removeItem('jwt_token');
            currentUserRole = null; // Reset the user role
            
            authView.classList.remove('hidden');
            dashboardView.classList.add('hidden');
            authForm.reset();
            authError.textContent = '';
            // Reset to login mode view
            if (!isLoginMode) {
                toggleMode(true);
            }
        }

        // ** NEW: Add a function to check login status on page load **
        function checkLoginStatus() {
            const token = getToken();
            if (token) {
                const payload = parseJwt(token);
                if (payload) {
                    currentUserRole = payload.role; // Set the global role
                    showDashboard({ user: { name: payload.name } });
                } else {
                    // If token is invalid or expired
                    showLoginView();
                }
            }
        }

        function toggleMode(forceLogin = null) {
            isLoginMode = (forceLogin !== null) ? forceLogin : !isLoginMode;
            authForm.reset();
            authError.textContent = '';
            const link = document.getElementById('toggle-auth-mode');
            if (isLoginMode) {
                authTitle.textContent = 'Sign in to your account';
                link.innerHTML = 'create a new account';
                authButton.textContent = 'Sign in';
                nameField.classList.add('hidden');
            } else {
                authTitle.textContent = 'Create a new account';
                link.innerHTML = 'sign in to your account';
                authButton.textContent = 'Create Account';
                nameField.classList.remove('hidden');
            }
        }

        function renderDashboardStats(stats) {
            document.getElementById('stats-active-members').textContent = stats.active_members || 0;
            document.getElementById('stats-total-members').textContent = stats.total_members || 0;
            
            // Use the ?. optional chaining operator to safely get counts.
            // If a plan doesn't exist in the data, it will show 0 instead of causing an error.
            document.getElementById('stats-plan-monthly').textContent = stats.plan_distribution?.Monthly || 0;
            document.getElementById('stats-plan-quarterly').textContent = stats.plan_distribution?.Quarterly || 0;
            document.getElementById('stats-plan-yearly').textContent = stats.plan_distribution?.Yearly || 0;
        }
        
        // --- Event Listeners ---
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authForm.email.value;
            const password = authForm.password.value;
            authError.textContent = '';
            if (isLoginMode) {
                try {
                    const userData = await loginUser(email, password);
                    showDashboard(userData);
                } catch (error) {
                    authError.textContent = error.message;
                }
            } else {
                const name = authForm.name.value;
                await registerUser(name, email, password);
            }
        });

        toggleAuthModeLink.addEventListener('click', (e) => {
            e.preventDefault();
            toggleMode();
        });

        logoutButton.addEventListener('click', () => {
            showLoginView();
        });

        addMemberBtn.addEventListener('click', () => {
            memberForm.reset();
            memberModal.classList.add('active');
        });

        cancelModalBtn.addEventListener('click', () => {
            memberModal.classList.remove('active');
        });

        memberForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const memberData = {
                name: document.getElementById('member-name').value,
                email: document.getElementById('member-email').value,
                membership_plan: document.getElementById('member-plan').value,
            };

            // Check if we are editing or adding
            const editingId = e.target.dataset.editingId;
            if (editingId) {
                updateMember(editingId, memberData);
            } else {
                addMember(memberData);
            }
        });

        // ** NEW: Call the checkLoginStatus function when the page loads **
        document.addEventListener('DOMContentLoaded', checkLoginStatus);

    </script>
</body>
</html>